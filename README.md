# PANAFACOM LKIT-16にSD-CARDとのロード、セーブ機能

シリアル同期通信によりLKIT-16とSD_ACCESS(ARDUINO+SD-CARD)とのロード、セーブを提供するルーチンです。

## 必要なハードウェア
 MN-1630(下位バイト側)
 
 2708(改造により2716等)
 
 ピンヘッダ等
 
## 注意点
　下位バイト側のMN-1630増設は必須です。

　LKIT-16のROMは2708ですので次の要件が必須です。

　　・Monitor-ROMのダンプリストがあり、2708の書き換えも大丈夫

　　・Monitor-ROMのダンプリストがあり、2716等を2708ソケットに装着できるアダプタもあり、2716書き込み装置もある

　　・Monitor-ROMのダンプリストは無いが、2716等を2708ソケットに装着できるアダプタもあり、2716書き込み装置もある場合には、拡張ROMとして2716等に焼いて装着してください。完全リロケータブルなのでバイナリに手直しは必要ありません。LKIT-16起動後にFunc(1)、Func(2)のTLOAD定数、TSAVE定数を書き換えておけば普通に使えます。

　私は、Monitor-ROMの内容をLEDにダンプ表示させたものを見ながら手で打ち込んでダンプリストを作成し、2716-2708変換アダプタで運用しています。

## 接続方法
Arduino　　　　　　　　　　LKIT-16

　　5V　　　　　　　-----　　5V
   
　　GND　　　　　　-----　　GND
   
　　9(FLG:output)　　-----　　ST0(CHK:input)
             
　　8(OUT:output)　　-----　　ST1(IN:input)
                
　　7(CHK:input)　　　-----　　CM2(FLG:output)
                
　　6(IN :input)　　　-----　　CM3(OUT:output)

## ROM
　Monitor-ROMダンプリストがある方はfile_trans_LKIT16(H 0416-04E8).BINを上位バイトダンプ、file_trans_LKIT16(L 0416-04E8).BINを下位バイトダンプの内容に差し替えてください。

　またMonitor-ROM下位バイトダンプに以下の修正を加えることでTLOAD定数、TSAVE定数の初期化をSD-Card用に変更できます。

　　0149 94　->　16

　　014A 16　->　17

　・Monitor-ROMのダンプリストは無いが、2716等を2708ソケットに装着できるアダプタもあり、2716書き込み装置もある場合には、拡張ROMとして2716等に焼いて装着してください。完全リロケータブルなのでバイナリに手直しは必要ありません。LKIT-16起動後にFunc(1)のTLOAD定数を0500H、、Func(2)のTSAVE定数を0501Hと書き換えておけば同様に使えます。

## 操作方法
### Load
　　LoadしたいファイルNoの4桁を入力し、SETADRSキーを押します。LKIT-16の場合アクセスできないアドレスだった場合エラーとなるのでCANCLキーでエラーを解除します。

　　次にテープロードと同じくFunc(1)の操作をすることでLoadが開始されます。

　　Load中はLoadしているアドレスとデータが表示されますが、早すぎてなんだかわかりません。あぁLoadしているんだなぐらいに見てください。

　　正常に終了されればOKと表示されます。ここでSTOPキー以外のキーを押すことでモニターに復帰できます。

　　STOPキーを押してモニターに復帰してしまうとスタックが中途半端になり、後々エラーが発生しますので注意してください。

　　Loadが終わるとLoad先頭アドレスをFunc(3)に実行開始アドレスとしてセットしてありますので良ければそのままFunc(3)の操作をすることでプログラムの実行が可能です。

　　Errと表示された場合は、SD-Cardが挿入されていない、ファイルNoのファイルが存在しない、読み込み中に何らかのエラーが発生した場合ですので確認してください。

### Save
　まず、テープストア開始アドレス(000C)、テープストア終了アドレス(000D)をセットします。

　次にSaveするファイルNoを4桁で入力し、SETADRSキーを押します。LKIT-16の場合アクセスできないアドレスだった場合エラーとなるのでCANCLキーでエラーを解除します。

　　ファイルの上書きは禁止しています。SD-Cardに存在しないファイルNoを入力してください。

　　次にテープロードと同じくFunc(2)の操作をすることでSaveが開始されます。

　　Save中はSaveしているアドレスとデータが表示されますが、早すぎてなんだかわかりません。あぁSaveしているんだなぐらいに見てください。

　　、正常に終了されればOKと表示されます。ここでSTOPキー以外のキーを押すことでモニターに復帰できます。

　　STOPキーを押してモニターに復帰してしまうとスタックが中途半端になり、後々エラーが発生しますので注意してください。

　　次にSAVE開始アドレスを入力してWRITEINCRキーを押し、最後にSAVE終了アドレスを入力してWRITEINCRキーを押せばSaveが開始され、正常に終了されればEndと表示されます。

　　Errorと表示された場合は、SD-Cardが挿入されていない、ファイルNoのファイルが既に存在する(上書き不可です)、書き込み中に何らかのエラーが発生した場合ですので確認してください。

## 扱えるファイル
　拡張子btkとなっているバイナリファイルです。
 
　ファイル名は0000～FFFFまでの16進数4桁を付けてください。(例:0100.btk)
 
　この16進数4桁がLKIT-16からSD-Card内のファイルを識別するファイルNoとなります。
 
　構造的には、バイナリファイル本体データの先頭に4バイトの開始アドレス、終了アドレスを付加した形になっています。
 
　パソコンのクロスアセンブラ等でLKIT-16用の実行binファイルを作成したらバイナリエディタ等で先頭に4バイトの開始アドレス、終了アドレスを付加し、ファイル名を変更したものをSD-Cardのルートディレクトリに保存すればLKIT-16から呼び出せるようになります。

　LKIT-16は16Bitですが、btkファイルは8Bitを想定していますので終了アドレスは8Bit換算として設定してください。

## 実装
　実際に作成したアダプタです。

アダプタの表です。

![SD-Cardアダプタ(表)](https://github.com/yanataka60/LKIT16_SD/blob/main/JPG/SD-Card%E3%82%A2%E3%83%80%E3%83%97%E3%82%BF(%E8%A1%A8).JPG)

アダプタの裏です。

![SD-Cardアダプタ(裏)](https://github.com/yanataka60/LKIT16_SD/blob/main/JPG/SD-Card%E3%82%A2%E3%83%80%E3%83%97%E3%82%BF(%E8%A3%8F).JPG)

LKIT-16側のコネクタ部です。

![コネクタ](https://github.com/yanataka60/LKIT16_SD/blob/main/JPG/%E3%82%B3%E3%83%8D%E3%82%AF%E3%82%BF.JPG)

実際に装着したところです。

![装着](https://github.com/yanataka60/LKIT16_SD/blob/main/JPG/%E8%A3%85%E7%9D%80.JPG)

## その他
　パソコン側のクロスアセンブラとしてThe　Macroassembler　AS　1.42Bld211を使っていますが、WT命令がWRとして定義されており、ソースをそのままアセンブルするとエラーが発生します。

　1.42Bld211であればASW.EXEの20CB5FH番地52Hを54Hに修正してアセンブルしてください。
